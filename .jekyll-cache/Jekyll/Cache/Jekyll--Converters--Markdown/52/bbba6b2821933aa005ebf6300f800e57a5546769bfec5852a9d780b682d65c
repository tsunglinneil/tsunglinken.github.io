I"‹<p>æ•´åˆæ¸¬è©¦åœ¨æœ¬åœ°ç«¯é€²è¡Œå¾€å¾€æœƒèˆ‡å¯¦éš›éƒ¨ç½²ç’°å¢ƒæœ‰å¾ˆå¤§çš„è½å·®ï¼Œç„¶è€Œ Docker å®¹å™¨åŒ–çš„æŠ€è¡“ä½¿å¾—ç’°å¢ƒå»ºç«‹çš„é–€æª»é™ä½ã€‚</p>

<p>é€™ç¯‡æ–‡ç« å°‡å¾æ•´åˆæ¸¬è©¦åœ¨å¯¦å‹™ä¸Šæœƒé‡åˆ°çš„å•é¡Œï¼Œä¸¦æ ¹æ“šç¾ä»Šè»Ÿé«”é–‹ç™¼çš„è¶¨å‹¢ï¼Œæ­é… Kafkaã€Redisã€RDBMSï¼Œèªªæ˜å¦‚ä½•é‹ç”¨å®¹å™¨åŒ–çš„æŠ€è¡“è§£æ±ºå¯¦å‹™ä¸Šæ¸¬è©¦çš„å›°é›£é»ã€‚</p>

<h2 id="æœ¬ç¯‡æ–‡ç« ä¸­æåŠä¹‹å„ç¨®æ¸¬è©¦åè©èªªæ˜">æœ¬ç¯‡æ–‡ç« ä¸­æåŠä¹‹å„ç¨®æ¸¬è©¦åè©èªªæ˜</h2>

<ul>
  <li>å–®å…ƒæ¸¬è©¦ â†’ é–‹ç™¼äººå“¡æ’°å¯«çš„å–®å…ƒæ¸¬è©¦</li>
  <li>æ•´åˆæ¸¬è©¦ â†’ é–‹ç™¼äººå“¡æ’°å¯«çš„æ•´åˆæ¸¬è©¦</li>
  <li>æ‰‹å‹•æ•´åˆæ¸¬è©¦ â†’ éƒ¨ç½²åˆ°å…±äº«ç’°å¢ƒä¸­çš„ä½¿ç”¨è€…æ¸¬è©¦</li>
</ul>

<p>è‹¥æƒ³æš¸è§£æ›´å¤šé—œæ–¼æ•´åˆæ¸¬è©¦/å–®å…ƒæ¸¬è©¦ï¼Œæä¾›ä»¥ä¸‹æ˜•åŠ›å¤§å­¸è³‡æºåƒè€ƒ</p>

<ul>
  <li><a href="https://www.tpisoftware.com/tpu/articleDetails/1256">Spring Boot çš„å–®å…ƒæ¸¬è©¦</a></li>
  <li><a href="https://www.tpisoftware.com/tpu/articleDetails/1294">æ¨¡æ“¬æ¸¬è©¦æ¡†æ¶ Mockito ä»‹ç´¹</a></li>
</ul>

<h2 id="è«‡è«‡æ•´åˆæ¸¬è©¦å¯¦å‹™ä¸Šçš„å•é¡Œ">è«‡è«‡æ•´åˆæ¸¬è©¦å¯¦å‹™ä¸Šçš„å•é¡Œ</h2>

<div class="row">
    <div class="col"><img src="/images/testcontainers/1.png" width="150" height="150" alt="" /></div>
    <div class="col"><img src="/images/testcontainers/turn.png" width="150" height="150" alt="" /></div>
    <div class="col"><img src="/images/testcontainers/2.png" width="150" height="150" alt="" /></div>
</div>
<p>å¦‚ä¸Šåœ–å¯çœ‹åˆ°å»£ç‚ºäººçŸ¥çš„æ¸¬è©¦é‡‘å­—å¡”(æ­¤æ¦‚å¿µæºè‡ªæ–¼<em><a href="https://www.mountaingoatsoftware.com/company/about-mike-cohn">Mike Cohn</a></em> ï¼Œå¯æŸ¥é–±<a href="https://www.mountaingoatsoftware.com/blog/the-forgotten-layer-of-the-test-automation-pyramid">é€™ç¯‡ BLOG æ–‡ç« </a>)ï¼Œæè¿°äº†å„å€‹å±¤ç´šçš„æ¸¬è©¦æ¯”é‡æ‡‰è©²è¦æ˜¯å–®å…ƒæ¸¬è©¦&gt;æ•´åˆæ¸¬è©¦&gt;æ‰‹å‹•æ•´åˆæ¸¬è©¦ï¼Œç„¶è€Œå¯¦å‹™ä¸Šçš„ç‹€æ³å‰‡é€šå¸¸ç›¸åï¼Œæ‰‹å‹•æ•´åˆé›†æˆæ¸¬è©¦çš„æ¯”é‡æœ€é«˜ â†’ å¾é‡‘å­—å¡”è®Šæˆäº†å†°æ·‡æ·‹ ?</p>

<p><strong>æ•´åˆæ¸¬è©¦é‡åˆ°çš„å•é¡Œå¤§è‡´å¦‚ä¸‹ï¼š</strong></p>

<ul>
  <li>æ•´åˆæ¸¬è©¦ç›¸è¼ƒæ–¼å–®å…ƒæ¸¬è©¦ï¼Œé‹è¡Œçš„æ™‚é–“å’Œæˆæœ¬éƒ½è¼ƒé«˜ã€‚</li>
  <li>ç’°å¢ƒå»ºç½®è¤‡é›œï¼Œéœ€è¦åœ¨é–‹ç™¼ç’°å¢ƒé å…ˆå®‰è£å»ºç½®å¥½æ‰€éœ€å·¥å…·ï¼Œä¾‹å¦‚: è³‡æ–™åº«ç­‰å¤–éƒ¨ä¾è³´ã€‚</li>
</ul>

<p>è—‰ç”±ä¸Šè¿°çš„å•é¡Œï¼Œç’°å¢ƒå»ºç½®è¤‡é›œåº¦çš„æˆæœ¬æ˜¯æ›´ä¸»è¦çš„åŸå› ï¼Œå› æ­¤å¯ä»¥ç†è§£ç‚ºä½•è¨±å¤šæƒ…æ³ä¸‹æœƒå„ªå…ˆè€ƒæ…®ç›´æ¥éƒ¨ç½²åˆ° SIT/UAT ç’°å¢ƒé€²è¡Œæ‰‹å‹•æ•´åˆæ¸¬è©¦ã€‚</p>

<h2 id="æ‰€ä»¥å°±ç¹¼çºŒæ‰‹å‹•æ•´åˆæ¸¬è©¦å§">æ‰€ä»¥å°±ç¹¼çºŒæ‰‹å‹•æ•´åˆæ¸¬è©¦å§!?</h2>

<p>æˆ‘å€‘å…ˆæŠŠç›®å…‰è½‰ç§»åˆ°å¹¾å€‹é¢å‘</p>

<ul>
  <li><strong>å¾®æœå‹™ã€‚</strong></li>
  <li><strong>åˆ†æ•£å¼ã€‚</strong></li>
</ul>

<p>åœ¨ä¸Šè¿°ä¸»æµçš„æ¶æ§‹ç•¶ä¸­ï¼Œæœå‹™å’Œå­˜å„²è£ç½®ä¸å†åªæ˜¯é›†ä¸­åœ¨ä¸€å€‹åœ°æ–¹ï¼Œè€Œæ˜¯èƒ½å¤ åˆ†æ•£åˆ°åœ¨å„åœ°é‹ä½œï¼Œä»¥é”åˆ°éˆæ´»ã€å»¶å±•ã€é«˜å¯ç”¨ã€è³‡æ–™éš”é›¢ç­‰ç­‰å„ªé»ï¼Œä½†ä¹Ÿè¡ç”Ÿäº†ä¸€äº›å•é¡Œ</p>

<ul>
  <li>å¤šå€‹æœå‹™ä¹‹é–“çš„ä»‹æ¥æ¸¬è©¦æˆæœ¬é«˜ï¼Œéœ€è¦éƒ¨ç½²å¤šå€‹æœå‹™å¾Œæ‰èƒ½é€²è¡Œå®Œæ•´æ¸¬è©¦ã€‚</li>
  <li>è³‡æ–™åˆè©²å¦‚ä½•å…±äº«ã€‚</li>
</ul>

<p>ç‚ºäº†å› æ‡‰ä¸Šè¿°çš„æ¶æ§‹ï¼Œå¾€å¾€æœƒéœ€è¦æ­é…ä¸€äº›è§£æ±ºæ–¹æ¡ˆ</p>

<ul>
  <li>ä¾‹å¦‚ä½ éœ€è¦éƒ¨ç½²çš„æœå‹™è®Šå¤šäº†ï¼Œéœ€è¦å°å…¥ CI/CD è‡ªå‹•åŒ–ä½ çš„éƒ¨ç½²æµç¨‹ï¼Œç¯€çœé–‹ç™¼äººå“¡çš„å·¥ä½œï¼Œä½†ç›¸å°è‡ªå‹•éƒ¨ç½²é »ç‡çš„æé«˜ï¼Œä¹Ÿä½¿å¾—æ¸¬è©¦äººå“¡å¯èƒ½æ›´ç„¡æ³•å³æ™‚çš„å»æ¸¬è©¦æ¯æ¬¡æ›´æ–°çš„æ­£ç¢ºæ€§ã€‚</li>
  <li>ä¾‹å¦‚ä½ å¯èƒ½é‚„æœƒéœ€è¦æ­å»ºå¤–éƒ¨ç·©å­˜æ©Ÿåˆ¶ã€æ¶ˆæ¯ä»£ç†ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨ä¾è³´æ•¸é‡å¢åŠ ï¼Œéœ€è¦æ¸¬è©¦çš„ç’°ç¯€ä¹Ÿè®Šå¤šäº†ï¼Œæ¯æ¬¡ç‚ºäº†é©—è­‰é€™äº›å¤–éƒ¨ä¾è³´ï¼Œåˆåªä¾é æ‰‹å‹•æ•´åˆæ¸¬è©¦çš„æƒ…æ³ä¸‹ï¼Œå¯èƒ½åªèƒ½å¢åŠ éƒ¨ç½²çš„é »ç‡ã€‚</li>
</ul>

<p>å°šæœªå¯¦æ–½ä¸Šè¿°æ¶æ§‹çš„åœ˜éšŠï¼Œå¯èƒ½å…ˆä¸ç”¨æ“”å¿ƒé€™äº›å•é¡Œï¼Œä½†ç›¸ä¿¡ä¸€å®šæœ‰é‡éä¸‹åˆ—æƒ…å¢ƒ</p>

<ul>
  <li>å¤šåœ˜éšŠå”ä½œï¼Œåœ¨å…±äº«ç’°å¢ƒä¸­éƒ¨ç½²ã€æ›´æ–°äº†å…±äº«è³‡æºï¼Œä¾‹å¦‚:è³‡æ–™åº«ã€ç¬¬ä¸‰æ–¹å¥—ä»¶ç­‰ç­‰ï¼Œé€ æˆå…¶ä¸­ä¸€æ–¹çš„åŠŸèƒ½ç„¡æ³•æ­£ç¢ºè¢«é©—è­‰ï¼Œè€Œç¨‹å¼å¯èƒ½æ ¹æœ¬å°±æ²’æœ‰ç•°å‹•ã€‚</li>
  <li>é–‹ç™¼æ¸¬è©¦å…±ç”¨è³‡æ–™åº«ï¼Œå› ç‚ºå¤šäººé–‹ç™¼ï¼Œè³‡æ–™æˆ–æ•¸æ“šåº«è¢«ä¿®æ”¹ï¼Œé€ æˆæ¸¬è©¦çµæœå¤±æ•—æˆ–ä¸æº–ç¢ºã€‚</li>
  <li>
    <p>æ­é… H2 æ’°å¯«æ•´åˆæ¸¬è©¦æ™‚ï¼Œå³ä½¿é€šéæ¸¬è©¦ï¼Œç•¶éƒ¨ç½²åˆ°ç·šä¸Šç’°å¢ƒæ™‚ä¾ç„¶æœƒå‡ºéŒ¯ï¼Œä¸»è¦åŸå› å’Œå•é¡Œå¦‚ä¸‹</p>

    <ol>
      <li>SQL èªæ³•ä¸å…¼å®¹ã€‚</li>
      <li>éœ€ç¶­è­·å¤šå€‹ç‰ˆæœ¬çš„ SQL èªæ³•ã€‚</li>
      <li>ç’°å¢ƒè³‡æ–™è¡¨è½å·®ã€‚</li>
    </ol>
  </li>
</ul>

<p>ä¸è«–å“ªç¨®æƒ…å¢ƒï¼Œéƒ½é¡¯ç¤ºå‡ºæ•´åˆæ¸¬è©¦åœ¨é–‹ç™¼è€…çš„ç’°å¢ƒä¸­é€²è¡Œæ˜¯æœ‰å¿…è¦çš„ï¼Œä½†å¦‚åŒå‰é¢æåˆ°çš„ï¼Œç’°å¢ƒå»ºç½®çš„æˆæœ¬æ˜¯å€‹å¤§å•é¡Œã€‚</p>

<h2 id="å®¹å™¨åŒ–æ•´åˆæ¸¬è©¦æ–¹æ¡ˆé¸æ“‡">å®¹å™¨åŒ–æ•´åˆæ¸¬è©¦æ–¹æ¡ˆé¸æ“‡</h2>

<p>æ—¢ç„¶æœ‰å®¹å™¨åŒ–çš„æŠ€è¡“ï¼Œä½¿ç”¨ Container ä¾†é€²è¡Œæ•´åˆæ¸¬è©¦æœƒæ˜¯ä¸€å€‹é¸æ“‡ã€‚</p>

<ul>
  <li>
    <p><a href="https://docs.docker.com/compose/">Docker-Compose</a></p>

    <p>å°‡å¤šå€‹æœå‹™å»ºæ§‹æˆ Images ä»¥ docker-compose up çš„æ–¹å¼åŸ·è¡Œï¼Œä½†æœ‰ä¸€äº›ä¾·é™æ€§ã€‚</p>

    <ol>
      <li>æ¯å€‹æœå‹™çš„ PORT æ˜¯å›ºå®šçš„ï¼Œåœ¨ç’°å¢ƒä¸Šçš„é…ç½®é€ æˆäº†é™åˆ¶ï¼Œä¸”ç„¡æ³•é€²è¡Œä¸¦è¡Œæ¸¬è©¦ã€‚</li>
      <li>å¤šå€‹æ¸¬è©¦å¯èƒ½ç„¡æ³•åŒæ™‚é€²è¡Œï¼Œå› ç‚ºä¹Ÿè¨±åœ¨ A æƒ…å¢ƒä¸‹çš„æ¸¬è©¦è³‡æ–™ä¸æ‡‰ç•™åˆ° B æƒ…å¢ƒã€‚</li>
      <li>ç•¶æœ‰å¤šå€‹ä¸åŒæœå‹™æˆ–ç‰ˆæœ¬éœ€è¦è¢«æ¸¬è©¦æ™‚ï¼Œé…ç½®å°‡æœƒæ˜¯å€‹å•é¡Œã€‚</li>
      <li>æ¯æ¬¡æ¸¬è©¦å‰å¾Œéƒ½éœ€è¦è‡ªè¡Œå•Ÿå‹•/é—œé–‰ Containerã€‚</li>
    </ol>
  </li>
  <li>
    <p><a href="https://github.com/fabric8io/docker-maven-plugin">Maven Plugin - docker-maven-plugin</a></p>

    <p>è‹¥æƒ³é”åˆ°è‡ªå‹•åŒ–æ¸¬è©¦ï¼ŒMaven çš„é…ç½®æ–¹æ¡ˆä¹Ÿè¨±å¯ä»¥è€ƒæ…®ï¼Œä½†ä¹Ÿæœ‰ä¸Šè¿°æåˆ°çš„éƒ¨åˆ†å•é¡Œã€‚</p>
  </li>
  <li>
    <p><a href="https://docs.docker.com/engine/api/v1.40/#">Docker API</a></p>

    <p>Docker æä¾›äº† REST APIï¼Œå› æ­¤è‹¥æ˜¯å¯ä»¥è‡ªè¡Œä½¿ç”¨é€™äº› APIï¼Œå°‡å¯ä½¿å¾—æ•´åˆæ¸¬è©¦çš„è¨­è¨ˆæ›´éˆæ´»ã€‚</p>
  </li>
</ul>

<p>æ¥è‘—é€²å…¥æœ¬ç¯‡é‡é»ï¼Œçµåˆ JVM èˆ‡ Container ä¾†å¯¦ç¾æ•´åˆæ¸¬è©¦</p>

<h2 id="ä»‹ç´¹-testcontainers">ä»‹ç´¹ TestContainers</h2>

<p>æ“·å–<a href="https://github.com/testcontainers/testcontainers-java">é–‹æºå°ˆæ¡ˆ</a>ä¸Šé‡å° TestContainers çš„èªªæ˜</p>

<p><code class="language-plaintext highlighter-rouge">â€Testcontainers is a Java 8 library that supports JUnit tests, providing lightweight, throwaway instances of common databases, Selenium web browsers, or anything else that can run in a Docker container.â€</code></p>

<p>åˆæ­¥å¯ä»¥å¾—çŸ¥ï¼ŒTestcontainers æ˜¯ Java8 çš„é¡åº«ï¼Œæ¡ç”¨å®¹å™¨åŒ–çš„æŠ€è¡“ï¼Œèƒ½å¤ å„è‡ªç¨ç«‹é‹è¡Œä¸¦ä½¿ç”¨èˆ‡ Production ç›¸åŒç‰ˆæœ¬çš„å¤–éƒ¨ä¾è³´ï¼Œä¸” Container èƒ½é‹è¡Œåœ¨å„å€‹ä¸åŒå¹³å°çš„ç‰¹æ€§ï¼Œæ¸›å°‘äº†ç’°å¢ƒæ­å»ºçš„è¤‡é›œåº¦ã€‚</p>

<p>TestContainer èƒ½å¤ ä½¿ç”¨ä»»ä½•å…·æœ‰ Docker Image çš„å¤–éƒ¨ä¾è³´é …ç›®ï¼Œä¾‹å¦‚: è³‡æ–™åº«ã€Web ç€è¦½å™¨å·¥å…·ã€æ¶ˆæ¯ä»£ç†ã€ç¶²é ä¼ºæœå™¨ç­‰ç­‰ï¼ŒåŒæ™‚ä¹Ÿæ”¯æ´ JVM çš„æ¸¬è©¦æ¡†æ¶ï¼Œä¾‹å¦‚: JUnitï¼Œå¦å¤–é‚„æ”¯æŒå„ç¨®èªè¨€çš„ç‰ˆæœ¬ï¼Œç›®å‰ Java çš„ç‰ˆæœ¬æ˜¯æ¯”è¼ƒå®Œæ•´çš„ï¼ˆ<a href="https://github.com/testcontainers">é»æ“ŠæŸ¥é–±æ”¯æ´é …ç›®æ¸…å–®</a>ï¼‰ã€‚</p>

<h2 id="æ‡‰ç”¨å ´æ™¯">æ‡‰ç”¨å ´æ™¯</h2>

<ul>
  <li>
    <p><strong>è³‡æ–™åº«æ•¸æ“šå­˜å–å±¤çš„æ•´åˆæ¸¬è©¦</strong></p>

    <p>Example: ä»»ä½•å®¹å™¨åŒ–çš„è³‡æ–™åº«é¡å‹ï¼ŒMySQLã€Postgrestâ€¦</p>
  </li>
  <li>
    <p><strong>å¤–éƒ¨ä¾è³´é …ç›®çš„æ•´åˆæ¸¬è©¦</strong></p>

    <p>Example: LDAPã€Redisã€Kafkaã€Micro Serviceã€Nginxâ€¦</p>
  </li>
  <li>
    <p><strong>è‡ªå‹•åŒ– UI æ•´åˆæ¸¬è©¦</strong></p>

    <p>Example: Selenium browser</p>
  </li>
  <li>
    <p><strong>è‡ªå‹•åŒ–æ•´åˆæ¸¬è©¦</strong></p>

    <p>Example: dind-drone-plugin</p>
  </li>
</ul>

<h2 id="å°å…¥åœ˜éšŠå‰çš„å»ºè­°äº‹é …">å°å…¥åœ˜éšŠå‰çš„å»ºè­°äº‹é …</h2>

<ul>
  <li>å…·æœ‰ Docker çš„æ¦‚å¿µåŠæ“ä½œç¶“é©—å°‡å¯å¹«åŠ©ç†è§£å…¶é‹ä½œã€‚</li>
  <li>ç¢ºèªä¸¦åˆ—å‡ºéœ€è¦è¢«æ¸¬è©¦çš„å¤–éƒ¨ä¾è³´é …ç›®ï¼Œä¸€é–‹å§‹å…ˆèšç„¦ç¢ºèªå¥½æ¸¬è©¦çš„ç›®çš„å’Œæ–¹å‘æœƒçœä¸‹è¨±å¤šæ™‚é–“ã€‚</li>
</ul>

<h2 id="å¯¦éš›æ¸¬è©¦ç¯„ä¾‹èªªæ˜">å¯¦éš›æ¸¬è©¦ç¯„ä¾‹èªªæ˜</h2>

<h3 id="ï¸-å°ˆæ¡ˆçµæ§‹ç°¡è¿°"><strong>â–¶ï¸ å°ˆæ¡ˆçµæ§‹ç°¡è¿°</strong></h3>

<p>åˆ†åˆ¥ä»¥ Kafkaã€Redisã€RDBMS(MSSQL)é€²è¡Œï¼Œä½¿ç”¨ Spring Boot 2 åŠ Junit 5ï¼Œä¸¦å¼•ç”¨å‰è¿°ä¾è³´(Kafkaã€Redisã€MSSQL)æ’°å¯« Production Code æˆ–é…ç½®ï¼Œå†å¼•ç”¨ Testcontainers Spring Boot çš„ä¾è³´æ’°å¯«æ¸¬è©¦ã€‚</p>

<p><strong>â€¢ Maven ä¾è³´</strong></p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-logging<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;exclusions&gt;</span>
        <span class="nt">&lt;exclusion&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.junit.vintage<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>junit-vintage-engine<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/exclusion&gt;</span>
    <span class="nt">&lt;/exclusions&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- test - junit 5 --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.junit.jupiter<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>junit-jupiter-api<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.4.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.junit.jupiter<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>junit-jupiter-params<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.4.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.junit.jupiter<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>junit-jupiter-engine<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.4.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h3 id="ï¸-å¯¦éš›æ¼”ç·´-kafka"><strong>â–¶ï¸</strong> <strong>å¯¦éš›æ¼”ç·´-Kafka</strong></h3>

<p>å»ºç½® Spring Boot 2 å°ˆæ¡ˆï¼Œä¸¦å¼•ç”¨ Kafka ä¾è³´ï¼Œå»ºç«‹ Producer ç™¼é€æ¶ˆæ¯ã€Consumer è¨‚é–± Topic å–å¾—ä¸¦å›æ‡‰è¨Šæ¯ï¼Œé€™è£¡åœ¨æœ¬åœ°ç’°å¢ƒä¸å»å®‰è£åŠå»ºç«‹ Kafkaï¼Œä¹Ÿä¸ä½¿ç”¨ Embedded Kafkaï¼Œè€Œæ˜¯ä½¿ç”¨ TestContainers å”åŠ©å»ºç«‹ Kafka Container é€²è¡Œæ•´åˆæ¸¬è©¦ã€‚</p>

<p><strong>â€¢ Maven ä¾è³´</strong></p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- kafka streams --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.kafka<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>kafka-streams<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- kafka spring --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.kafka<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-kafka<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- test - testcontainers - kafka --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>kafka<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.14.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- test - kafka test util --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.kafka<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-kafka-test<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p><strong>èªªæ˜ï¼š</strong></p>

<p>spring-kafka-test ä¾è³´ï¼Œå¯ä»¥è®“æˆ‘å€‘è¼•æ˜“çš„å»é©—è­‰ Producerï¼†Consumer çš„è³‡æ–™ç‹€æ…‹ã€‚</p>

<p><strong>â€¢ Kafka Producer å¯¦ä½œ</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@ConditionalOnProperty</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"enable.kafka"</span><span class="o">,</span> <span class="n">havingValue</span><span class="o">=</span><span class="s">"true"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KafkaSenderService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">DatabaseInitialService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">kafkaTemplate</span><span class="o">;</span>

    <span class="nd">@EventListener</span><span class="o">(</span><span class="nc">ApplicationStartedEvent</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">kafkaTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">"testcontainers"</span><span class="o">,</span> <span class="s">"kafka"</span><span class="o">,</span> <span class="s">"TestcontainersKafka"</span><span class="o">).</span><span class="na">addCallback</span><span class="o">(</span><span class="n">result</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">RecordMetadata</span> <span class="n">recordMetadata</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getRecordMetadata</span><span class="o">();</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"producer send data to {}, {}, {}"</span><span class="o">,</span> <span class="n">recordMetadata</span><span class="o">.</span><span class="na">topic</span><span class="o">(),</span> <span class="n">recordMetadata</span><span class="o">.</span><span class="na">partition</span><span class="o">(),</span>
                        <span class="n">recordMetadata</span><span class="o">.</span><span class="na">offset</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="n">ex</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"something wrong..."</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">});</span>

        <span class="n">kafkaTemplate</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>èªªæ˜ï¼š</strong></p>

<p>åˆ©ç”¨ KafkaTemplate ä¾†å¹«åŠ©æˆ‘å€‘æ›´å®¹æ˜“çš„å»ºç«‹ Topic ä»¥åŠæ¬²å¯«å…¥çš„è³‡æ–™</p>

<p>10: å¯«å…¥ key/value â€œkafkaâ€/â€TestcontainersKafkaâ€ çµ¦ Kafka Topic â€œtestcontainersâ€ï¼Œä¸¦ log å°å‡ºè³‡è¨Šã€‚</p>

<p><strong>â€¢ å»ºç«‹æ¸¬è©¦</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="kd">class</span> <span class="nc">KafkaTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">KafkaTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">static</span> <span class="nc">KafkaContainer</span> <span class="n">kafkaContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaContainer</span><span class="o">();</span>

    <span class="nd">@DynamicPropertySource</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">kafkaProperties</span><span class="o">(</span><span class="nc">DynamicPropertyRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">kafkaContainer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.kafka.properties.bootstrap.servers"</span><span class="o">,</span> <span class="nl">kafkaContainer:</span><span class="o">:</span><span class="n">getBootstrapServers</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.kafka.consumer.group-id"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">"testcontainersapp"</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.kafka.consumer.properties.auto.offset.reset"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">"earliest"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">KafkaProperties</span> <span class="n">properties</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testKafkaProducerSendDataAndConsumerReceiveData</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;[]</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Consumer</span><span class="o">[]{</span><span class="n">createConsumer</span><span class="o">(</span><span class="s">"testcontainers"</span><span class="o">)};</span>

        <span class="nc">String</span> <span class="n">actual</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ConsumerRecords</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="nc">KafkaTestUtils</span><span class="o">.</span><span class="na">getRecords</span><span class="o">(</span><span class="n">consumer</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="mi">10000</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">records</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">ConsumerRecord</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">record</span> <span class="o">:</span> <span class="n">records</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">actual</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">assertEquals</span><span class="o">(</span><span class="s">"TestcontainersKafka"</span><span class="o">,</span> <span class="n">actual</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">createConsumer</span><span class="o">(</span><span class="nc">String</span> <span class="n">topicName</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span>
                <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultKafkaConsumerFactory</span><span class="o">&lt;&gt;(</span><span class="n">properties</span><span class="o">.</span><span class="na">buildConsumerProperties</span><span class="o">(),</span> <span class="nl">StringDeserializer:</span><span class="o">:</span><span class="k">new</span><span class="o">,</span>
                        <span class="nl">StringDeserializer:</span><span class="o">:</span><span class="k">new</span><span class="o">).</span><span class="na">createConsumer</span><span class="o">();</span>

        <span class="n">consumer</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">topicName</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">consumer</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>èªªæ˜ï¼š</strong></p>

<p>5: å¯¦ä¾‹åŒ– Kafka Containerã€‚</p>

<p>7-13: å•Ÿå‹• Kafka Container ä¸¦å‹•æ…‹æŒ‡å®šè¨­å®šæª”åƒæ•¸ã€‚</p>

<p>18-34: åˆ©ç”¨ Kafka Consumer API å–å¾—è¨‚é–±çš„ Topic â€œtestcontainersâ€è³‡æ–™ã€‚</p>

<p>36-43: å¯¦ä¾‹åŒ– Kafka Consumer ä¸¦è¨‚é–± Topic â€œtestcontainersã€‚</p>

<p><strong>â€¢ åŸ·è¡Œæ¸¬è©¦</strong></p>

<p><strong>[å•Ÿå‹•å®¹å™¨]</strong></p>

<div><img src="/images/testcontainers/kafka/startup.png" width="800" height="150" alt="" /></div>

<p><strong>[æ¸¬è©¦çµæœ]</strong></p>

<div><img src="/images/testcontainers/kafka/run-test.png" width="800" height="150" alt="" /></div>

<h3 id="ï¸-å¯¦éš›æ¼”ç·´-rdbmsmssql"><strong>â–¶ï¸</strong> <strong>å¯¦éš›æ¼”ç·´-RDBMS(MSSQL)</strong></h3>

<p>å»ºç½® Spring Boot 2 å°ˆæ¡ˆï¼Œä¸¦å¼•ç”¨ MSSQL ä¾è³´ï¼Œé€™è£¡åœ¨æœ¬åœ°ç’°å¢ƒä¸å»å®‰è£åŠå»ºç«‹ MSSQLï¼Œè€Œæ˜¯ä½¿ç”¨ TestContainers å”åŠ©å»ºç«‹ MSSQL Container é€²è¡Œæ•¸æ“šå±¤çš„æ•´åˆæ¸¬è©¦ã€‚</p>

<p><strong>â€¢ Maven ä¾è³´</strong></p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- mssql server --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.microsoft.sqlserver<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mssql-jdbc<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- test - testcontainers - mssql server --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mssqlserver<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.14.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p><strong>â€¢ Model &amp; Repository (ä½¿ç”¨ Spring Data JPA)</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** Model */</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"book_category"</span><span class="o">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="s">"dbo"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookCategory</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">bookSeq</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">categoryName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">sort</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">suspend</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span><span class="o">=</span><span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"book_seq"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getBookSeq</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">bookSeq</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBookSeq</span><span class="o">(</span><span class="kt">int</span> <span class="n">bookSeq</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bookSeq</span> <span class="o">=</span> <span class="n">bookSeq</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Basic</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"category_name"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCategoryName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">categoryName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCategoryName</span><span class="o">(</span><span class="nc">String</span> <span class="n">categoryName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">categoryName</span> <span class="o">=</span> <span class="n">categoryName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Basic</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"sort"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSort</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sort</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSort</span><span class="o">(</span><span class="kt">int</span> <span class="n">sort</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sort</span> <span class="o">=</span> <span class="n">sort</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Basic</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"suspend"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getSuspend</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">suspend</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSuspend</span><span class="o">(</span><span class="nc">String</span> <span class="n">suspend</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">suspend</span> <span class="o">=</span> <span class="n">suspend</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">BookCategory</span> <span class="nf">createBookCategory</span><span class="o">(</span><span class="nc">String</span> <span class="n">categoryName</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sort</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BookCategory</span> <span class="n">bookCategory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BookCategory</span><span class="o">();</span>
        <span class="n">bookCategory</span><span class="o">.</span><span class="na">setCategoryName</span><span class="o">(</span><span class="n">categoryName</span><span class="o">);</span>
        <span class="n">bookCategory</span><span class="o">.</span><span class="na">setSort</span><span class="o">(</span><span class="n">sort</span><span class="o">);</span>
        <span class="n">bookCategory</span><span class="o">.</span><span class="na">setSuspend</span><span class="o">(</span><span class="s">"N"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">bookCategory</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">BookCategory</span> <span class="n">that</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BookCategory</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">bookSeq</span> <span class="o">==</span> <span class="n">that</span><span class="o">.</span><span class="na">bookSeq</span> <span class="o">&amp;&amp;</span>
            <span class="n">sort</span> <span class="o">==</span> <span class="n">that</span><span class="o">.</span><span class="na">sort</span> <span class="o">&amp;&amp;</span>
            <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">categoryName</span><span class="o">,</span> <span class="n">that</span><span class="o">.</span><span class="na">categoryName</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
            <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">suspend</span><span class="o">,</span> <span class="n">that</span><span class="o">.</span><span class="na">suspend</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">bookSeq</span><span class="o">,</span> <span class="n">categoryName</span><span class="o">,</span> <span class="n">sort</span><span class="o">,</span> <span class="n">suspend</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/** Repository */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BookCategoryRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">BookCategory</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>èªªæ˜ï¼š</strong></p>

<p>å»ºç«‹ Entity ç‰©ä»¶åŠ Spring Data JPA Repositoryã€‚</p>

<p><strong>â€¢ åˆå§‹åŒ–è³‡æ–™è¡¨</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="n">ANSI_NULLS</span> <span class="k">ON</span>

<span class="k">SET</span> <span class="n">QUOTED_IDENTIFIER</span> <span class="k">ON</span>

<span class="k">SET</span> <span class="n">ANSI_PADDING</span> <span class="k">ON</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">book_category</span> <span class="p">(</span>
  <span class="n">book_seq</span> <span class="nb">int</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
  <span class="n">category_name</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">sort</span> <span class="nb">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">suspend</span> <span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">CONSTRAINT</span> <span class="n">DF_book_category_suspend</span> <span class="k">DEFAULT</span> <span class="p">(</span><span class="s1">'N'</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="n">PK_book_category</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">CLUSTERED</span> <span class="p">(</span>
    <span class="n">book_seq</span> <span class="k">ASC</span>
  <span class="p">),</span>
<span class="p">);</span>

<span class="k">SET</span> <span class="n">ANSI_PADDING</span> <span class="k">OFF</span>

<span class="k">EXEC</span> <span class="n">sys</span><span class="p">.</span><span class="n">sp_addextendedproperty</span> <span class="o">@</span><span class="n">name</span><span class="o">=</span><span class="n">N</span><span class="s1">'MS_Description'</span><span class="p">,</span> <span class="o">@</span><span class="n">value</span><span class="o">=</span><span class="n">N</span><span class="s1">'åˆ†é¡'</span><span class="p">,</span> <span class="o">@</span><span class="n">level0type</span><span class="o">=</span><span class="n">N</span><span class="s1">'SCHEMA'</span><span class="p">,</span> <span class="o">@</span><span class="n">level0name</span><span class="o">=</span><span class="n">N</span><span class="s1">'dbo'</span><span class="p">,</span> <span class="o">@</span><span class="n">level1type</span><span class="o">=</span><span class="n">N</span><span class="s1">'TABLE'</span><span class="p">,</span> <span class="o">@</span><span class="n">level1name</span><span class="o">=</span><span class="n">N</span><span class="s1">'book_category'</span>

<span class="k">EXEC</span> <span class="n">sys</span><span class="p">.</span><span class="n">sp_addextendedproperty</span> <span class="o">@</span><span class="n">name</span><span class="o">=</span><span class="n">N</span><span class="s1">'MS_Description'</span><span class="p">,</span> <span class="o">@</span><span class="n">value</span><span class="o">=</span><span class="n">N</span><span class="s1">'æµæ°´è™Ÿ'</span><span class="p">,</span> <span class="o">@</span><span class="n">level0type</span><span class="o">=</span><span class="n">N</span><span class="s1">'SCHEMA'</span><span class="p">,</span> <span class="o">@</span><span class="n">level0name</span><span class="o">=</span><span class="n">N</span><span class="s1">'dbo'</span><span class="p">,</span> <span class="o">@</span><span class="n">level1type</span><span class="o">=</span><span class="n">N</span><span class="s1">'TABLE'</span><span class="p">,</span> <span class="o">@</span><span class="n">level1name</span><span class="o">=</span><span class="n">N</span><span class="s1">'book_category'</span><span class="p">,</span> <span class="o">@</span><span class="n">level2type</span><span class="o">=</span><span class="n">N</span><span class="s1">'COLUMN'</span><span class="p">,</span> <span class="o">@</span><span class="n">level2name</span><span class="o">=</span><span class="n">N</span><span class="s1">'book_seq'</span>

<span class="k">EXEC</span> <span class="n">sys</span><span class="p">.</span><span class="n">sp_addextendedproperty</span> <span class="o">@</span><span class="n">name</span><span class="o">=</span><span class="n">N</span><span class="s1">'MS_Description'</span><span class="p">,</span> <span class="o">@</span><span class="n">value</span><span class="o">=</span><span class="n">N</span><span class="s1">'æ’åº(1-99)'</span><span class="p">,</span> <span class="o">@</span><span class="n">level0type</span><span class="o">=</span><span class="n">N</span><span class="s1">'SCHEMA'</span><span class="p">,</span> <span class="o">@</span><span class="n">level0name</span><span class="o">=</span><span class="n">N</span><span class="s1">'dbo'</span><span class="p">,</span> <span class="o">@</span><span class="n">level1type</span><span class="o">=</span><span class="n">N</span><span class="s1">'TABLE'</span><span class="p">,</span> <span class="o">@</span><span class="n">level1name</span><span class="o">=</span><span class="n">N</span><span class="s1">'book_category'</span><span class="p">,</span> <span class="o">@</span><span class="n">level2type</span><span class="o">=</span><span class="n">N</span><span class="s1">'COLUMN'</span><span class="p">,</span> <span class="o">@</span><span class="n">level2name</span><span class="o">=</span><span class="n">N</span><span class="s1">'sort'</span>

<span class="k">EXEC</span> <span class="n">sys</span><span class="p">.</span><span class="n">sp_addextendedproperty</span> <span class="o">@</span><span class="n">name</span><span class="o">=</span><span class="n">N</span><span class="s1">'MS_Description'</span><span class="p">,</span> <span class="o">@</span><span class="n">value</span><span class="o">=</span><span class="n">N</span><span class="s1">'åœç”¨å¦'</span><span class="p">,</span> <span class="o">@</span><span class="n">level0type</span><span class="o">=</span><span class="n">N</span><span class="s1">'SCHEMA'</span><span class="p">,</span> <span class="o">@</span><span class="n">level0name</span><span class="o">=</span><span class="n">N</span><span class="s1">'dbo'</span><span class="p">,</span> <span class="o">@</span><span class="n">level1type</span><span class="o">=</span><span class="n">N</span><span class="s1">'TABLE'</span><span class="p">,</span> <span class="o">@</span><span class="n">level1name</span><span class="o">=</span><span class="n">N</span><span class="s1">'book_category'</span><span class="p">,</span> <span class="o">@</span><span class="n">level2type</span><span class="o">=</span><span class="n">N</span><span class="s1">'COLUMN'</span><span class="p">,</span> <span class="o">@</span><span class="n">level2name</span><span class="o">=</span><span class="n">N</span><span class="s1">'suspend'</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'æ–‡å­¸å°èªª'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'å•†æ¥­ç†è²¡'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'è—è¡“è¨­è¨ˆ'</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'äººæ–‡å²åœ°'</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'ç¤¾æœƒç§‘å­¸'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'è‡ªç„¶ç§‘æ™®'</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'å¿ƒç†å‹µå¿—'</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'é†«ç™‚ä¿å¥'</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'é£²é£Ÿ'</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">dbo</span><span class="p">.</span><span class="n">book_category</span> <span class="p">(</span><span class="n">category_name</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">suspend</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">N</span><span class="s1">'ç”Ÿæ´»é¢¨æ ¼'</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'N'</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>èªªæ˜ï¼š</strong></p>

<p>æœ¬ç¯„ä¾‹ä¹‹æª”æ¡ˆæ”¾ç½®æ–¼ src/main/resources/â€¦.</p>

<p><strong>â€¢ å»ºç«‹æ¸¬è©¦</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DatabaseTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">DatabaseTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">static</span> <span class="nc">MSSQLServerContainer</span> <span class="n">mssqlserver</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MSSQLServerContainer</span><span class="o">)</span> <span class="k">new</span> <span class="nc">MSSQLServerContainer</span><span class="o">()</span>
        <span class="o">.</span><span class="na">withInitScript</span><span class="o">(</span><span class="s">"doc/ddl.sql"</span><span class="o">);</span>

    <span class="nd">@DynamicPropertySource</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mssqlProperties</span><span class="o">(</span><span class="nc">DynamicPropertyRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mssqlserver</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.driver-class-name"</span><span class="o">,</span> <span class="nl">mssqlserver:</span><span class="o">:</span><span class="n">getDriverClassName</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.url"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">mssqlserver</span><span class="o">.</span><span class="na">getJdbcUrl</span><span class="o">());</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.username"</span><span class="o">,</span> <span class="nl">mssqlserver:</span><span class="o">:</span><span class="n">getUsername</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.password"</span><span class="o">,</span> <span class="nl">mssqlserver:</span><span class="o">:</span><span class="n">getPassword</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">BookCategoryRepository</span> <span class="n">bookCategoryRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">testBookCategoryListSizeIs10</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BookCategory</span><span class="o">&gt;</span> <span class="n">bookCategoryList</span> <span class="o">=</span> <span class="n">bookCategoryRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">bookCategoryList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>èªªæ˜ï¼š</strong></p>

<p>5: å¯¦ä¾‹åŒ– MSSQL SERVER Containers ä¸¦æŒ‡å®šåˆå§‹åŒ–è³‡æ–™åº«çš„ Script æª”æ¡ˆï¼Œæœ¬ç¯„ä¾‹æœƒå»ºç«‹ book_category è³‡æ–™è¡¨ä¸¦å¯«å…¥ 10 ç­†è³‡æ–™ã€‚</p>

<p>8-15: å•Ÿå‹• MSSQL SERVER Containerï¼Œä¸¦å‹•æ…‹æŒ‡å®šè¨­å®šæª”åƒæ•¸ã€‚</p>

<p>20-24: é©—è­‰å¯å¦å¾ book_category è³‡æ–™è¡¨å–å‡º 10 ç­†è³‡æ–™ã€‚</p>

<p><strong>â€¢ åŸ·è¡Œæ¸¬è©¦</strong></p>

<p><strong>[å•Ÿå‹•å®¹å™¨]</strong></p>

<div><img src="/images/testcontainers/mssql/startup.png" width="800" height="150" alt="" /></div>

<p><strong>[æ¸¬è©¦çµæœ]</strong></p>

<div><img src="/images/testcontainers/mssql/run-test.png" width="800" height="150" alt="" /></div>

<h2 id="ï¸-å¯¦éš›æ¼”ç·´-redis"><strong>â–¶ï¸</strong> <strong>å¯¦éš›æ¼”ç·´-Redis</strong></h2>

<p>å»ºç½® Spring Boot 2 å°ˆæ¡ˆï¼Œä¸¦å¼•ç”¨ Redis ä¾è³´ï¼Œé€™è£¡åœ¨æœ¬åœ°ç’°å¢ƒä¸å»å®‰è£åŠå»ºç«‹ Redisï¼Œè€Œæ˜¯ä½¿ç”¨ TestContainers å”åŠ©å»ºç«‹ Redis Container é€²è¡Œæ•´åˆæ¸¬è©¦ã€‚</p>

<p><strong>â€¢ Maven ä¾è³´</strong></p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- spring data redis --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- test - testcontainers --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>testcontainers<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.14.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p><strong>â€¢ Redis é…ç½®</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RedisTemplate</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisTemplate</span><span class="o">();</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">());</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">GenericJackson2JsonRedisSerializer</span><span class="o">());</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setHashKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">());</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">redisTemplate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>èªªæ˜ï¼š</strong></p>

<p>é…ç½® RedisTemplate ä¸¦æŒ‡å®šå¯¦ä½œä¹‹ Serializerï¼ˆä¹Ÿå¯ä¾æ“šéœ€æ±‚ä½¿ç”¨å®¢è£½åŒ–çš„ Serializerï¼‰ï¼Œç•¶ä½¿ç”¨ RedisTemplate å°‡è³‡æ–™å¯«å…¥ Redis æ™‚ï¼Œæœƒæ ¹æ“šæŒ‡å®š Serializer é€²è¡Œè™•ç†ï¼Œå¦‚æ­¤ä¸€ä¾†å‰‡ç„¡éœ€åœ¨æ¯å€‹ç‰©ä»¶ä¸­å¯¦ä½œåºåˆ—åŒ–ã€‚</p>

<p><strong>â€¢ å»ºç«‹æ¸¬è©¦</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">RedisTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">static</span> <span class="nc">GenericContainer</span> <span class="n">redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">(</span><span class="s">"redis:5.0.5"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withExposedPorts</span><span class="o">(</span><span class="mi">6379</span><span class="o">);</span>

    <span class="nd">@DynamicPropertySource</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">redisProperties</span><span class="o">(</span><span class="nc">DynamicPropertyRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">redis</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.redis.host"</span><span class="o">,</span> <span class="nl">redis:</span><span class="o">:</span><span class="n">getContainerIpAddress</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.redis.port"</span><span class="o">,</span> <span class="nl">redis:</span><span class="o">:</span><span class="n">getFirstMappedPort</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSetAndGetWithString</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"k1"</span><span class="o">,</span> <span class="s">"v1"</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="s">"v1"</span><span class="o">,</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"k1"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSetAndGetWithObject</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">BookCategory</span> <span class="n">bookCategory</span> <span class="o">=</span> <span class="nc">BookCategory</span><span class="o">.</span><span class="na">createBookCategory</span><span class="o">(</span><span class="s">"ç”Ÿæ´»é¢¨æ ¼"</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"k2"</span><span class="o">,</span> <span class="n">bookCategory</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">categoryName</span> <span class="o">=</span> <span class="o">((</span><span class="nc">BookCategory</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"k2"</span><span class="o">)).</span><span class="na">getCategoryName</span><span class="o">();</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="s">"ç”Ÿæ´»é¢¨æ ¼"</span><span class="o">,</span> <span class="n">categoryName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@After</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destory</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">redis</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>èªªæ˜ï¼š</strong></p>

<p>5: å¯¦ä¾‹åŒ– Redis Containerï¼Œé€™è£¡ä½¿ç”¨çš„æ˜¯ GenericContainerï¼Œå¯ä»¥é€éé€™å€‹ç‰©ä»¶å‚³å…¥å®¢è£½åŒ–çš„ Image Nameï¼Œå¢åŠ æ¸¬è©¦å®¹å™¨çš„å½ˆæ€§ã€‚</p>

<p>8-13: å•Ÿå‹• Redis Containerï¼Œä¸¦å‹•æ…‹æŒ‡å®šè¨­å®šæª”åƒæ•¸ã€‚</p>

<p>18-22: é©—è­‰å¾ Redis å¯«å…¥/å–å‡ºå­—ä¸²è³‡æ–™çš„æ­£ç¢ºæ€§ã€‚</p>

<p>24-30: é©—è­‰å¾ Redis å¯«å…¥/å–å‡ºç‰©ä»¶è³‡æ–™çš„æ­£ç¢ºæ€§ã€‚</p>

<p><strong>â€¢ åŸ·è¡Œæ¸¬è©¦</strong></p>

<p><strong>[å•Ÿå‹•å®¹å™¨]</strong></p>

<div><img src="/images/testcontainers/redis/startup.png" width="800" height="150" alt="" /></div>

<p><strong>[æ¸¬è©¦çµæœ-1]</strong></p>

<div><img src="/images/testcontainers/redis/run-test1.png" width="800" height="150" alt="" /></div>

<p><strong>[æ¸¬è©¦çµæœ-2]</strong></p>

<div><img src="/images/testcontainers/redis/run-test2.png" width="800" height="150" alt="" /></div>

<h1 id="å¯¦éš›æ¼”ç·´å¿ƒå¾—"><strong>å¯¦éš›æ¼”ç·´å¿ƒå¾—</strong></h1>

<p>å–®å–®å°± Kafkaã€Redisã€RDBMS çš„æƒ…å¢ƒåˆ†åˆ¥å¯¦ä½œçš„éç¨‹ä¾†èªªï¼Œé€é TestContainers ç°¡åŒ–äº†è¨±å¤šæ­¥é©Ÿï¼Œä¹Ÿç„¡ç«¯å£è¡çªçš„å•é¡Œï¼Œç•¶ç„¶å¯ä»¥æƒ³åƒåœ¨è¼ƒç‚ºè¤‡é›œçš„å°ˆæ¡ˆæƒ…å¢ƒä¸­ä¸€å®šæœƒé‡åˆ°ä¸€äº›ä¸å¯é æœŸçš„ç‹€æ³ã€‚</p>

<p><strong>å®¹å™¨åŒ–çš„æ•´åˆæ¸¬è©¦æ–¹æ¡ˆä¸¦éå®Œå…¨æ²’æœ‰ç¼ºé»</strong>ï¼Œå¯¦éš›æ“ä½œç™¼ç¾ä»¥ä¸‹å•é¡Œï¼š</p>

<ol>
  <li>
    <p>æ¯å€‹æ¸¬è©¦éƒ½æœƒå•Ÿç”¨ Docker Containerï¼Œä¹Ÿå› æ­¤<strong>èŠ±è²»æ™‚é–“è¼ƒé•·</strong>ï¼ˆè‡ªå‹•éƒ¨ç½²é‹è¡Œè‡ªå‹•åŒ–æ¸¬è©¦èŠ±è²»æ™‚é–“äº¦æœƒæœ‰æ­¤å•é¡Œï¼‰ï¼Œé€™éƒ¨åˆ†å‰‡å¯ä»¥æ¡ç”¨<strong>ä¸¦è¡ŒåŒ–æ¸¬è©¦</strong>ä¾†è§£æ±ºã€‚</p>
  </li>
  <li>
    <p>éœ€è¦é€²è¡Œ<strong>é¡å¤–çš„é…ç½®å·¥ä½œ</strong>ï¼Œåƒæ˜¯é‡å°åˆå§‹åŒ–è³‡æ–™åº«ï¼Œæœ¬ç¯‡æ–‡ç« ä½¿ç”¨çš„æ˜¯ MSSQLï¼Œè€Œ Testcontainer çš„ MSSQL çš„è§£æå¯¦ä½œä¸Šæœƒæ“‹æ‰æŸäº›èªå¥ï¼Œå› æ­¤å°±å¿…é ˆè¦èŠ±è²»ä¸€äº›æ™‚é–“æ¸¬è©¦è³‡æ–™åˆå§‹åŒ–çš„ Scriptã€‚</p>
  </li>
</ol>

<p>ç„¶è€Œæ•´é«”ä¾†èªªï¼Œç›¸è¼ƒæ–¼æ¯æ¬¡éƒ½è¦éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒé€²è¡Œé©—è­‰ï¼Œå³ä¾¿æ˜¯ä½¿ç”¨è‡ªå‹•åŒ–éƒ¨ç½²ï¼Œéƒ¨ç½²ä¸Šå»ç‰ˆæœ¬é›£å…é‚„æ˜¯å¯èƒ½ç™¼ç”Ÿä¸å¯é æœŸç‹€æ³ï¼ˆä¾‹å¦‚æ¨é€å¤±æ•—ã€åˆä½µå•é¡Œç­‰ç­‰ï¼‰ï¼Œå› æ­¤å®¹å™¨åŒ–æ•´åˆæ¸¬è©¦æˆ‘è¦ºå¾—æ˜¯å€¼å¾—å˜—è©¦çš„ä¸€å€‹è§£æ±ºæ–¹æ¡ˆã€‚</p>

<p>æœ‰ä»»ä½•å•é¡Œï¼Œæ­¡è¿è¯ç¹«è¨è«–ï¼Œè¬è¬~!</p>

<hr />

<p>References:</p>

<ul>
  <li><strong><a href="https://www.testcontainers.org/">å®˜æ–¹æ–‡æª”</a></strong></li>
  <li><strong><a href="https://reflectoring.io/spring-boot-flyway-testcontainers/">å¥½æ–‡ç« ï¼Œèªªæ˜äº†è³‡æ–™åº«æ•´åˆæ¸¬è©¦çš„å•é¡Œä»¥åŠç‚ºä½•æˆ‘å€‘éœ€è¦ä½¿ç”¨ TestContainer</a></strong></li>
  <li><strong><a href="https://github.com/testcontainers/testcontainers-spring-boot">å¥½è³‡æºï¼Œæä¾›å…¨é¢çš„ç¯„ä¾‹åŠä½¿ç”¨èªªæ˜ï¼Œè®“ä½ çŸ¥é“åœ¨ä¸åŒæƒ…å¢ƒä¸‹å¦‚ä½•ä½¿ç”¨ Testcontainer</a></strong></li>
  <li><strong><a href="https://piotrminkowski.com/2019/10/09/part-1-testing-kafka-microservices-with-micronaut/">å¥½ç¯„ä¾‹ï¼ŒSpring Boot TestContainers With Kafka</a></strong></li>
</ul>
:ET